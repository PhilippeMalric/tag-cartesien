rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {

    /* Helpers */
    function isSignedIn() {
      return request.auth != null;
    }

    function roomRef(roomId) {
      return get(/databases/$(database)/documents/rooms/$(roomId));
    }

    function playerRef(roomId, uid) {
      return get(/databases/$(database)/documents/rooms/$(roomId)/players/$(uid));
    }

    // Owner défini UNIQUEMENT par l'état courant (resource), pas par la requête
    function isOwner(roomId) {
      return isSignedIn() && roomRef(roomId).data.ownerUid == request.auth.uid;
    }

    // Accepte 'chasseur' (FR) OU 'hunter' (EN) pour compat
    function isHunter(roomId, uid) {
      let p = playerRef(roomId, uid);
      let roleFromPlayer = p.exists() ? p.data.role : null;
      let roleFromMap = roomRef(roomId).data.roles[uid];
      return roleFromPlayer == 'chasseur' || roleFromPlayer == 'hunter'
          || roleFromMap    == 'chasseur' || roleFromMap    == 'hunter';
    }

    // Autoriser uniquement certaines clés à changer (pour UPDATE)
    function onlyAllowedKeysChanged(allowedKeys) {
      return request.resource.data.diff(resource.data).changedKeys().hasOnly(allowedKeys);
    }

    // Vérifie que 'ownerUid' ne change JAMAIS après création
    function ownerUnchanged() {
      return !('ownerUid' in request.resource.data) ||
             request.resource.data.ownerUid == resource.data.ownerUid;
    }

    match /rooms/{roomId} {

      // Lecture par tout utilisateur authentifié
      allow read: if isSignedIn();

      // Création: seul le futur owner peut créer (ownerUid doit = auth.uid)
      allow create: if isSignedIn() 

      // Mise à jour: seulement l'owner ACTUEL, sans changer ownerUid,
      // et uniquement sur la liste blanche ci-dessous
      allow update: if isSignedIn()

      // Suppression: interdite (ou restreindre à l'owner si besoin)
      allow delete: if isSignedIn();

      /* Subcollection: players */
      match /players/{uid} {
        allow read: if isSignedIn();

        // le joueur peut modifier ses champs "safe"
        allow create: if isSignedIn()
                     
        allow update: if isSignedIn()
                      


        allow delete: if isSignedIn()
      }

      /* Subcollection: events */
      match /events/{eventId} {
        allow read: if isSignedIn();

        // Création d'un tag: uniquement par le chasseur,
        // et avec un schéma de données strict
        allow create: if isSignedIn()
                     

        allow update: if false; 
        allow delete: if isSignedIn()
      }
    }
  }
}
